# tools/generate_fortune_json.py
# -*- coding: utf-8 -*-

import argparse
import hashlib
import json
from dataclasses import dataclass
from datetime import date as Date
from pathlib import Path
from random import Random
from typing import Any, Dict, List, Sequence


DEFAULT_OUT = Path("assets/config/fortune_daily.json")

MAIN_IDS = ["mitarashi", "anko", "goma", "sanshoku", "zunda", "yomogi", "kinako", "sakura"]
SUB_PATTERNS = ["A", "B", "C", "D"]


# -------------------------
# utils
# -------------------------
def _norm(s: Any) -> str:
    """Normalize whitespace and convert to str."""
    s = "" if s is None else str(s)
    return " ".join(s.split()).strip()


def _dedupe_keep_order(items: Sequence[Any]) -> List[str]:
    seen = set()
    out: List[str] = []
    for x in items:
        x = _norm(x)
        if not x:
            continue
        if x in seen:
            continue
        seen.add(x)
        out.append(x)
    return out


def _seed_from_date(d: Date) -> int:
    """Stable seed from date (YYYY-MM-DD) -> int."""
    h = hashlib.sha256(d.isoformat().encode("utf-8")).hexdigest()
    return int(h[:16], 16)  # 64-bit enough


def _pick_n_cycle_mostly_unique(rng: Random, items: Sequence[Any], n: int) -> List[str]:
    """
    Prefer no duplicates: shuffle unique pool and cycle if needed.
    (If pool is small, duplicates only appear after exhausting uniques.)
    """
    pool = _dedupe_keep_order(items)
    if not pool:
        raise ValueError("pool is empty")

    # if n <= len(pool): sample without replacement
    if n <= len(pool):
        return rng.sample(pool, n)

    # otherwise: shuffle once and then cycle with reshuffle each cycle to avoid patterns
    out: List[str] = []
    remaining = n
    base = pool[:]
    while remaining > 0:
        rng.shuffle(base)
        take = min(remaining, len(base))
        out.extend(base[:take])
        remaining -= take
    return out


def _pick_n_unique_if_possible(rng: Random, items: Sequence[Any], n: int) -> List[str]:
    """Unique if enough, else fall back to cycle (duplicates only if necessary)."""
    pool = _dedupe_keep_order(items)
    if not pool:
        raise ValueError("pool is empty")
    if len(pool) >= n:
        return rng.sample(pool, n)
    # not enough: cycle to fill
    return _pick_n_cycle_mostly_unique(rng, pool, n)


def _require_keys(d: Dict[str, Any], keys: Sequence[str], ctx: str) -> None:
    missing = [k for k in keys if k not in d]
    if missing:
        raise KeyError(f"[{ctx}] missing keys: {missing}")


# -------------------------
# bank
# -------------------------
def make_bank() -> Dict[str, Any]:
    # 短文（不足してもOK。できるだけ重複を避ける埋め方は生成側で対応）
    day_theme = {
        "mitarashi": [
            "安心感が鍵になる日", "寄り添いが報われる日", "優しさが通りやすい日", "心の距離が縮まりやすい日",
            "小さな気遣いが効く日", "穏やかさが運気を整える日", "言葉の温度が大切な日", "受け止め力が評価される日",
            "安心を配れる人が強い日", "信頼の土台が固まりやすい日",
            "焦らないほど上手くいく日", "相手の不安がほどけやすい日", "“大丈夫”が魔法になる日", "優先順位を整える日",
            "余裕が魅力になる日", "静かな好転が起きる日", "やわらかい空気が味方の日", "甘えさせる力が試される日",
            "相手の本音が出やすい日", "ゆっくり進むほど勝てる日",
        ],
        "anko": [
            "誠実さが刺さる日", "信頼が積み上がる日", "約束が味方する日", "継続が運気を上げる日",
            "丁寧さが評価される日", "堅実に進めるほど伸びる日", "言葉より行動が効く日", "筋の通った判断が勝つ日",
            "一貫性が魅力になる日", "信用が増える日",
            "小さな努力が実る日", "ペースを守るほど好転する日", "“守る”が強さになる日", "淡々と進めて成果が出る日",
            "誠意が伝わりやすい日", "信頼の回収日", "積み重ねが報われる日", "約束を固めると安定する日",
            "ルールが味方する日", "きちんと整える日",
        ],
        "goma": [
            "判断が冴える日", "落ち着きが光る日", "整理すると運が開く日", "大人の余裕が効く日",
            "現実的な選択が当たる日", "ブレない決断が強い日", "段取りが成果を呼ぶ日", "静かに優位を取れる日",
            "距離感の調整が上手い日", "冷静さが武器の日",
            "情報の取捨選択が鍵の日", "要点を絞るほど進む日", "無理をしない方が勝つ日", "優先順位が整う日",
            "見通しが立ちやすい日", "慎重さが守ってくれる日", "確実に積み上がる日", "余白が次を生む日",
            "整えると流れが良くなる日", "大局で見ると勝てる日",
        ],
        "sanshoku": [
            "ノリが味方する日", "人運が強い日", "場の空気で勝てる日", "会話が弾みやすい日",
            "誘いが通りやすい日", "褒めが刺さりやすい日", "タイミングが合う日", "勢いで扉が開く日",
            "社交性が武器になる日", "偶然がチャンスに変わる日",
            "一歩踏み出すと進む日", "テンポが勝負の日", "軽やかに動くと当たる日", "明るさが伝染する日",
            "出会いが増える日", "繋がりが広がる日", "雰囲気が追い風の日", "楽しい方へ寄せると吉の日",
            "反応が返りやすい日", "笑顔が運を呼ぶ日",
        ],
        "zunda": [
            "発想力が武器になる日", "自由さが魅力の日", "好奇心が導く日", "冒険が当たる日",
            "型破りが刺さる日", "新しい提案が通りやすい日", "直感が当たりやすい日", "軽やかに動くと吉の日",
            "変化が追い風の日", "“あなたらしさ”が強い日",
            "固定観念を外すと伸びる日", "一歩ズラすと上手くいく日", "試すほど道が見える日", "予定を組み替えると良い日",
            "新鮮さが関係を動かす日", "挑戦が報われる日", "行動が景色を変える日", "遊び心が福を呼ぶ日",
            "軽いサプライズが効く日", "自由に選ぶほど整う日",
        ],
        "yomogi": [
            "安定が強い日", "調和で勝てる日", "家庭運が上がる日", "穏やかさが信頼を呼ぶ日",
            "習慣が運気を育てる日", "ゆっくり整える日", "守りが固い日", "継続が結果になる日",
            "安心の空気が広がる日", "落ち着くほど良くなる日",
            "丁寧に暮らすと吉の日", "身近な幸せが増える日", "信頼が深まる日", "余裕を作ると回る日",
            "静かな確信が持てる日", "関係が安定する日", "温かい会話が増える日", "受け身でも運が動く日",
            "整えるほど運が増す日", "無理しない方が勝つ日",
        ],
        "kinako": [
            "共感が刺さる日", "繊細さが活きる日", "感受性が武器の日", "言語化が当たる日",
            "気づきが運を開く日", "やさしさが伝わる日", "相手の心がほどける日", "配慮が光る日",
            "寄り添いが深まる日", "丁寧な会話が増える日",
            "小さな違和感に気づける日", "気持ちの整理が進む日", "安心を作ると回る日", "静かな理解が生まれる日",
            "言葉で救える日", "共感で距離が縮む日", "深い話ができる日", "心の温度を合わせる日",
            "優しさが報われる日", "境界線が大事な日",
        ],
        "sakura": [
            "ロマンが追い風の日", "感性が当たる日", "ドラマチック運の日", "雰囲気作りで勝てる日",
            "言葉選びが刺さる日", "余韻が残る日", "ときめきが増える日", "ムードが整う日",
            "美意識が運を動かす日", "特別感が作れる日",
            "感情が動きやすい日", "印象が残りやすい日", "未来の話が進む日", "景色が味方する日",
            "想像力が冴える日", "詩的な気分が吉の日", "小さな演出が効く日", "言葉が魔法になる日",
            "余白を残すと恋が進む日", "世界が少し綺麗に見える日",
        ],
    }

    recommended_move = {
        "mitarashi": [
            "相手の不安を先に拾って、安心できる一言を添える。",
            "決めつけずに『どうしたい？』と選択肢を渡す。",
            "返信は早さより温度。やわらかい言葉で返す。",
            "自分の予定も大事にしつつ、相手のペースを尊重する。",
            "小さな気遣いを“行動”で見せる（飲み物・時間・段取り）。",
            "今日は“聞き役”の方が関係が深まる。",
            "相手の頑張りを具体的に褒めて、心をほどく。",
            "『大丈夫』のひと言を、いつもより一回多めに。",
        ],
        "anko": [
            "小さな約束を一つ決めて、確実に守る。",
            "返信は短くてもいいので、誠実さが伝わる言い方にする。",
            "曖昧にせず、予定を一つだけ確定させる。",
            "やることを一行で共有して、信頼のズレを防ぐ。",
            "相手の話を受けたら“次の一手”まで提示する。",
            "余計な駆け引きはせず、淡々と丁寧に進める。",
            "相手の不安要素を整理して、安心材料を渡す。",
            "“続ける”ための小さな習慣を一つ提案する。",
        ],
        "goma": [
            "情報を整理して、要点だけ短く伝える。",
            "結論を急がず、前提を一つ確認してから動く。",
            "無理のない提案で、現実的に前へ進める。",
            "今日は『選ぶ・捨てる』の判断が運を上げる。",
            "距離を詰めるより、安心できる間合いを作る。",
            "相手の状況を“言語化して整理”してあげると喜ばれる。",
            "次の一手を短く提示して、相手を迷わせない。",
            "反応が薄い時ほど落ち着いて、押しすぎない。",
        ],
        "sanshoku": [
            "短く明るく誘う（長文より一言勝負）。",
            "褒めは具体的に。『そこが好き』を一点狙いで。",
            "共通の話題を拾って、会話を前に転がす。",
            "勢いで一歩進める（ただし相手の都合は確認）。",
            "相手のテンションに合わせて熱量を微調整する。",
            "迷ったら“楽しい方”へ。空気が味方する。",
            "返事待ちの時間も、軽い冗談で温度を保つ。",
            "小さな誘いを投げて、反応を見てから広げる。",
        ],
        "zunda": [
            "新しい提案を一つ入れる（場所・話題・やり方）。",
            "自分の好みを素直に出して、魅力を立てる。",
            "軽いサプライズで空気を変える（重すぎない範囲）。",
            "予定を少しズラして、マンネリを崩す。",
            "ノリで試して、合うものだけ残す。",
            "型通りより“あなたらしさ”を優先する。",
            "思い切って一歩踏み出し、反応から学ぶ。",
            "新鮮さを出しつつ、共有の一言も忘れない。",
        ],
        "yomogi": [
            "相手の話を最後まで聞いて、安心を作る。",
            "一緒にできる小さな習慣を提案する。",
            "急がず、ゆっくり整える方が結果が出る。",
            "遠慮しすぎず、本音を“少しだけ”出す。",
            "身近なことを丁寧に。生活を整えるほど運が上がる。",
            "今日は守りが強い日。無理な挑戦はしない。",
            "安心できる提案（時間帯・場所・距離感）を選ぶ。",
            "静かな気遣いを積み、信頼を深める。",
        ],
        "kinako": [
            "『それ分かる』を丁寧に言って、共感を先に出す。",
            "相手の気持ちを言語化して返す（代弁が刺さる）。",
            "良い所を具体的に褒めて、安心を増やす。",
            "不安は抱え込まず、メモや短い言葉で外に出す。",
            "境界線を守る一言を添えて、疲れを防ぐ。",
            "相手の反応が薄くても、優しさの温度を保つ。",
            "気づいたことを小さく共有して、距離を縮める。",
            "重い確認は避けて、穏やかな問いかけにする。",
        ],
        "sakura": [
            "少しだけ特別感を演出する（場所・言葉・タイミング）。",
            "景色/音楽/映画など、雰囲気の話題を入れる。",
            "未来の話を一つ入れて、余韻を残す。",
            "言葉選びを丁寧にして、印象を強くする。",
            "盛りすぎず、現実に寄せたロマンで刺す。",
            "余白を残して引くと、相手の想像が動く。",
            "短い一言でも“詩的な温度”を意識する。",
            "会うなら夜寄り、メッセージなら余韻重視。",
        ],
    }

    caution_short = {
        "mitarashi": [
            "優しさの出しすぎで疲れないように。7割で十分。",
            "背負い込みすぎ注意。相手の課題は相手のもの。",
            "断れない流れに入ったら、一度立ち止まる。",
            "相手の機嫌を背負わない。線引きを忘れずに。",
            "『わかってあげなきゃ』が過剰になると消耗する。",
            "確認のしすぎは不安を増やす。落ち着いて。",
        ],
        "anko": [
            "正しさで追い込まない。柔らかい言葉を一言足す。",
            "理想を固めすぎない。今日は“現実の最適”を選ぶ。",
            "減点思考に寄ると空気が冷える。加点で見て。",
            "細部にこだわりすぎると前に進まない。",
            "相手のペースを尊重しつつ、自分も硬くならない。",
        ],
        "goma": [
            "ドライに見えない一言を添える（共感→結論）。",
            "結論を急ぎすぎると相手が閉じる。ワンクッション。",
            "評価っぽい言い方は避ける。提案の形にする。",
            "説明不足だと誤解される。前提を軽く共有。",
            "冷静さが“冷たさ”に見えないように注意。",
        ],
        "sanshoku": [
            "テンション差に注意。相手のペースを確認してから。",
            "軽くしすぎると誤解される。誠意を一言足す。",
            "勢い任せで約束しすぎない。確認を挟む。",
            "空気読みすぎで疲れないように。無理はしない。",
            "相手の都合を置き去りにしない。",
        ],
        "zunda": [
            "独走しすぎない。共有の一言を忘れずに。",
            "相手の不安を置き去りにしない。小さく確認。",
            "気分のムラで急展開しない。段階を踏む。",
            "予定を崩しすぎると信頼が落ちる。最低限は守る。",
            "新しさ優先で相手を振り回さないように。",
        ],
        "yomogi": [
            "我慢で溜め込まない。本音は小出しに。",
            "遠慮しすぎ注意。相手は気づけないこともある。",
            "受け身になりすぎると機会を逃す。小さく動く。",
            "気遣いのしすぎで疲れないように。",
            "安定を守りつつ、必要な確認は避けない。",
        ],
        "kinako": [
            "考えすぎで疲れないように。不安は外に出す。",
            "相手の顔色を読みすぎない。自分の軸も守る。",
            "自己否定に寄ると運が下がる。優しく扱う。",
            "境界線が曖昧になると消耗する。線引きを。",
            "不安を増幅させる想像は一旦ストップ。",
        ],
        "sakura": [
            "理想を盛りすぎない。相手の現実も尊重。",
            "言葉だけ先行しない。行動を小さく添える。",
            "温度差に注意。相手のペースを見て合わせる。",
            "期待の押し付けにならないように。",
            "ムードに乗りすぎて、肝心な確認を忘れない。",
        ],
    }

    # -------------------------
    # 長文（密度担当）：組み合わせで大量生成 → そこから選ぶ
    # -------------------------
    def build_long_pool(main_id: str, flavor: str) -> List[str]:
        vibe = {
            "mitarashi": {"key": ["安心", "ぬくもり", "受け止め", "寄り添い", "やさしさ"], "risk": ["背負い込み", "気疲れ", "尽くしすぎ", "不安の増幅"], "good": ["ほどける", "整う", "近づく", "深まる"]},
            "anko": {"key": ["誠実", "信頼", "継続", "約束", "筋"], "risk": ["正しさの押し付け", "硬さ", "減点思考", "理想の固さ"], "good": ["積み上がる", "整う", "安定する", "実る"]},
            "goma": {"key": ["整理", "判断", "段取り", "現実感", "余裕"], "risk": ["ドライに見える", "結論を急ぐ", "説明不足", "冷たく見える"], "good": ["整う", "進む", "噛み合う", "誤解が減る"]},
            "sanshoku": {"key": ["テンポ", "会話", "空気", "誘い", "明るさ"], "risk": ["軽く見える", "勢い任せ", "温度差", "都合無視"], "good": ["弾む", "広がる", "通る", "乗る"]},
            "zunda": {"key": ["自由", "好奇心", "冒険", "発想", "新鮮さ"], "risk": ["独走", "共有不足", "不安置き去り", "ムラ"], "good": ["動く", "変わる", "開く", "新しくなる"]},
            "yomogi": {"key": ["安定", "調和", "習慣", "家庭", "穏やかさ"], "risk": ["遠慮しすぎ", "溜め込み", "受け身", "我慢"], "good": ["深まる", "安定する", "育つ", "落ち着く"]},
            "kinako": {"key": ["共感", "言語化", "配慮", "気づき", "理解"], "risk": ["考えすぎ", "顔色読みすぎ", "自己否定", "境界線の曖昧"], "good": ["ほどける", "伝わる", "救われる", "近づく"]},
            "sakura": {"key": ["ロマン", "余韻", "雰囲気", "言葉", "ときめき"], "risk": ["理想の盛りすぎ", "言葉だけ先行", "温度差", "期待の押し付け"], "good": ["残る", "刺さる", "進む", "色づく"]},
        }[main_id]

        intros = [
            f"今日は{vibe['key'][0]}の流れが強く、心の反応がいつもより繊細に出やすい日。",
            f"全体運は落ち着いていて、{vibe['key'][1]}を意識するほど良い方向に進みやすい日。",
            f"今日は小さな選択が流れを作る日。特に{vibe['key'][2]}が運気の土台になる。",
            f"運の波は穏やかだけど、{vibe['key'][3]}の出し方で結果が大きく変わりやすい日。",
            f"今日は“雰囲気”に答えがある日。{vibe['key'][4]}をどう扱うかが鍵。",
        ]
        reasons = [
            "相手も自分も、言葉の温度に敏感になりやすいから。",
            "焦って結論を出すほど、噛み合わないズレが生まれやすいから。",
            f"小さな違和感が表に出やすく、丁寧に扱うほど{vibe['good'][0]}から。",
            "無理に押すより、余白を作るほど相手の本音が出やすいから。",
            f"今日は“安心できる前提”が整うほど、物事が{vibe['good'][1]}から。",
        ]

        adv = {
            "love": [
                f"恋は、先に安心を渡すほど{vibe['good'][2]}。短い一言でも『味方だよ』を入れて。",
                f"距離を詰めるより、相手の反応を一拍待つと{vibe['good'][3]}。急がないのが正解。",
                "今日は共感→提案の順番が効く。まず受け止めてから、次の一手を小さく出して。",
                "連絡するなら長文より“温度のある短文”。相手が返しやすい余白を残して。",
                "会うなら、安心できる場所・時間を選ぶと運が安定する。派手さより居心地重視。",
            ],
            "work": [
                "仕事は“要点の整理”が最強。まず優先順位を一つ決めてから動くと速い。",
                "今日は丁寧さが評価される。根回しや確認を一手入れると結果が安定する。",
                "詰めるより整える日。資料・段取り・言い回しを整えるほど進みやすい。",
                "短く共有すると誤解が減る。『今こうで、次これ』だけで十分伝わる。",
                "先にリスクを一個潰すと運が上がる。小さな手戻りを防ぐ動きが吉。",
            ],
            "money": [
                "金運は“守り”が強い日。固定費やサブスクを見直すと効果が大きい。",
                "今日は衝動買いより“比較”が吉。ひと晩寝かせるだけで精度が上がる。",
                "小さな節約より“漏れの修正”。無意識の出費を一つ止めると流れが整う。",
                "投資・大きい買い物は情報整理してから。結論を急がないほど失敗しにくい。",
                "誰かのおすすめより、自分の基準で選ぶと後悔が減る日。",
            ],
            "crush": [
                "気になるあの人には、“押す”より“余白”。相手が話したくなる間を作ると距離が縮む。",
                "今日は相手の価値観に寄り添う質問が刺さる。答えを引き出すより、気持ちを拾う。",
                "好意は匂わせで十分。直球より『あなたのそこ好き』を一点だけ伝えると強い。",
                "駆け引きより誠実さ。小さな約束（返信・時間・次の予定）を作ると関係が進む。",
                "相手が忙しそうなら支える姿勢を。『無理しないでね』の一言が効く日。",
            ],
        }[flavor]

        warn = {
            "love": [
                f"{vibe['risk'][0]}に寄ると運が崩れる。相手の課題まで背負わないで。",
                f"{vibe['risk'][1]}が出たら一度休む合図。今日は7割で十分。",
                f"{vibe['risk'][2]}は誤解を呼ぶ。やるなら“少しだけ”に留める。",
                f"{vibe['risk'][3]}に入ると視野が狭くなる。事実と想像を分けて。",
                "答え合わせを急ぐと空気が冷える。確認は“軽く”が吉。",
            ],
            "work": [
                "結論を急ぐと見落としが増える。確認を一回だけ挟んで。",
                "抱え込みは事故の元。今日だけは一つ共有しておくと安全。",
                "言い方が硬いと敵を作る。クッション言葉を足して。",
                "完璧主義に入ると進まない。70点で出して改善が吉。",
                "優先順位が散ると疲れる。やらないことを決めて。",
            ],
            "money": [
                "気分で買うと後でモヤる。今日は“買わない選択”が運を上げる。",
                "見栄の出費は運気を削る。必要性を一度だけ確認して。",
                "セールの勢いに乗りすぎ注意。『本当に使う？』の一問が守る。",
                "お金の話は言い方が強くなりがち。柔らかく伝えると関係が守られる。",
                "貸し借りは曖昧にしない。条件は短く明確に。",
            ],
            "crush": [
                "重い確認は避ける。今日は“軽い一歩”が正解。",
                "相手の反応を試す言い方は逆効果。素直さが一番強い。",
                "距離を詰めすぎると相手が守りに入る。テンポを合わせて。",
                "返信の遅さを不安に変換しない。事実と想像を分けて。",
                "嫉妬を出すと空気が固まる。今日は明るさが勝つ。",
            ],
        }[flavor]

        pool: List[str] = []
        for i in intros:
            for r in reasons:
                for a in adv:
                    for w in warn:
                        pool.append(f"{i} {r} {a} {w}")
        return _dedupe_keep_order(pool)

    love_fortune = {mid: build_long_pool(mid, "love") for mid in MAIN_IDS}
    work_fortune = {mid: build_long_pool(mid, "work") for mid in MAIN_IDS}
    money_fortune = {mid: build_long_pool(mid, "money") for mid in MAIN_IDS}
    crush_advice = {mid: build_long_pool(mid, "crush") for mid in MAIN_IDS}

    # 運気上昇のコツ（短〜中：不足してもOK）
    luck_tip = {
        "mitarashi": [
            "“安心できる環境”を作ると運が上がる。机・部屋・予定を整える。",
            "今日は温かい飲み物が吉。焦りを落として判断が冴える。",
            "無理に頑張らず、休む勇気が運を守る。",
            "感謝を言葉にすると運が巡る。短くでいい。",
            "『できたこと』を数えると心が安定して運気が上がる。",
        ],
        "anko": [
            "小さな約束を守るほど運が強くなる。継続が開運。",
            "予定を一つ確定させると流れが整う。",
            "片付け・整理が金運と連動。まず一点だけ整える。",
            "“先延ばし”を一つ終わらせると運が上がる。",
            "丁寧な挨拶が対人運を底上げする日。",
        ],
        "goma": [
            "メモ・手帳で思考を外に出すと運が整う。",
            "『やらないこと』を決めると一気に楽になる。",
            "深呼吸してから返信すると、対人の事故が減る。",
            "静かな場所で5分だけ整理すると、流れが良くなる。",
            "早寝が吉。判断の精度が上がって運が伸びる。",
        ],
        "sanshoku": [
            "笑顔を意識すると対人運が跳ねる日。",
            "軽い運動や散歩で気分を上げると運が回る。",
            "テンポ良い音楽が開運。気分が整うほどチャンスが来る。",
            "短いメッセージを送ると縁が動く。",
            "偶然の誘いに乗れる余白を作ると運が上がる。",
        ],
        "zunda": [
            "新しいことを1つ試すと運が開く（小さくでOK）。",
            "ルート変更・席替えなど、微差の変化が開運。",
            "直感でピンと来たものをメモすると、後で当たる。",
            "予定を詰めすぎず、余白があるほどチャンスが来る。",
            "好奇心を肯定すると運が伸びる。",
        ],
        "yomogi": [
            "生活を整えるほど運が育つ日。まず睡眠を守る。",
            "部屋の空気を入れ替えると気分と運が切り替わる。",
            "身近な人に一言優しくすると、対人運が安定する。",
            "温かい食事が吉。心が落ち着いて流れが良くなる。",
            "“ゆっくり”が正解。急がないほど上手くいく。",
        ],
        "kinako": [
            "不安は紙に書くと消える。頭の外に出すのが開運。",
            "共感の言葉を一つ増やすと対人運が上がる。",
            "境界線を守ると運が安定する。『今日はここまで』でOK。",
            "やさしい香りが吉。気分が整うほど運が伸びる。",
            "深い話は短く。言い過ぎない方が余韻が残る。",
        ],
        "sakura": [
            "好きな音楽・景色で気分を整えると運が上がる。",
            "言葉を丁寧に選ぶと、恋愛運が一段上がる日。",
            "少しだけ特別感（香り・服・照明）で流れが変わる。",
            "夜の時間帯に直感が冴える。無理に昼に決めない。",
            "余白を残す行動が開運。詰めすぎない。",
        ],
    }

    # サブ：ラッキー系（40以上あるのでユニーク抽選OK）
    lucky_color = {
        "A": ["ピンク","白","ミルクティー","ベージュ","ローズ","淡いグレー","クリーム","桜色","ラベンダーピンク","アイボリー",
              "サーモンピンク","パールホワイト","くすみピンク","ピーチ","コットンホワイト","シェルピンク","ブロッサム","ペールピンク","オフホワイト","ミルキーグレー",
              "ピンクベージュ","ストロベリーミルク","ローズベージュ","バニラ","ライトベージュ","パウダーピンク","ベビーピンク","シルキーホワイト","ミストグレー","ミルクホワイト",
              "ピンクゴールド","チーク","ホワイトティー","リネン","クリームベージュ","淡いローズ","ピンクパール","フロスティホワイト","サクラミスト","ミルクピンク"],
        "B": ["ゴールド","オレンジ","炭酸","イエロー","赤","柑橘","コーラ","ハチミツ","サンセットオレンジ","レモン",
              "マンダリン","カナリア","ブロンズ","アンバー","みかん色","ビタミンイエロー","スパークルゴールド","パンプキン","トロピカル","コッパー",
              "サフラン","ゴールデンブラウン","アプリコット","ビビッドオレンジ","ハニーゴールド","サンフラワー","ライムイエロー","レッドオレンジ","メタリックゴールド","シトラス",
              "マンゴー","サンライト","ガーネット","オレンジソーダ","ゴールドラメ","ライトオレンジ","イエローゴールド","コーラブラウン","ビターブラウン","キャンディオレンジ"],
        "C": ["ネイビー","グレー","ブラックコーヒー","モノトーン","青","革小物","チェック柄","黒","スチールグレー","インクブルー",
              "ダークネイビー","チャコール","アッシュ","スモーク","ミッドナイト","ブラック","ダークグレー","グラファイト","スレート","クールグレー",
              "ブラックグレー","ナイトブルー","ネイビーブラック","ブルーグレー","アイアン","オブシディアン","マットブラック","インディゴ","シックネイビー","チャコールネイビー",
              "グレーシャー","ガンメタル","ペンシルグレー","コンクリート","ストーン","アビスブルー","深い青","影色","煤色","鉄色"],
        "D": ["パープル","シルバー","夜景","月","香水","キャンドル","音楽","ワインレッド","紫","星明かり",
              "ラベンダー","アメジスト","ムーンライト","メタリックシルバー","プラム","ダークパープル","スモーキーパープル","シルバーグレー","ナイトパープル","オーロラ",
              "ミッドナイトパープル","ディープワイン","バーガンディ","シルバーブルー","パールシルバー","紫紺","銀","星空色","夜の黒","月白",
              "パープルグレー","ヴァイオレット","プラチナ","サテンシルバー","夜の紫","深紫","月影","ネオン","夜の光","シネマカラー"],
    }

    lucky_item = {
        "A": ["温かい飲み物","ハンドクリーム","小さなハンカチ","やわらかい毛布","ミルク系スイーツ",
              "淡い色の服","保湿アイテム","アロマ","白いノート","やさしい香り",
              "リップクリーム","ティーバッグ","クッション","ブランケット","ミニポーチ",
              "お守り","マグカップ","キャンディ","絆創膏","ピンクの小物",
              "柔軟剤の香り","小さな鏡","日記","スープ","ストール",
              "入浴剤","ふわふわタオル","ホットアイマスク","ボディミルク","甘い紅茶",
              "シンプルなアクセ","コンパクト","ミストスプレー","カーディガン","白い靴下",
              "お花","ラテ","ぬいぐるみ","手紙","絆を感じるもの"],
        "B": ["スニーカー","炭酸飲料","ミントガム","明るい色の服","小さめのバッグ",
              "スポーツドリンク","イヤホン","サングラス","エナジーバー","帽子",
              "チケット","手帳アプリ","推しグッズ","オレンジ系小物","アクティブ系香り",
              "ストップウォッチ","折りたたみ傘","モバイルバッテリー","ビタミンC","シール",
              "派手めネイル","キーホルダー","炭酸水","ドリンクボトル","ポップな靴紐",
              "軽い上着","コンパクトカメラ","メモアプリ","笑える動画","グミ",
              "ゴールドアクセ","スポーツタオル","ショート動画","ステッカー","小銭入れ",
              "コーラ","柑橘の香り","アクティブウェア","リング","お菓子"],
        "C": ["手帳","ペン","クリアファイル","ブラックコーヒー","モノトーンの服",
              "革小物","PCスタンド","整理ボックス","付箋","名刺入れ",
              "静かな音楽","書類ケース","タイマー","メガネ拭き","ノイズキャンセラ",
              "チェック柄","シンプル時計","水","深呼吸","メモ帳",
              "マグネット","USBケーブル","充電器","デスクライト","黒い靴",
              "ミニマリスト財布","資料","ラベルシール","整頓","黒ペン",
              "クリップ","落ち着く香り","タスク管理","ファイル","黒いバッグ",
              "ネイビーの小物","インク","ノートPC","紙のメモ","定規"],
        "D": ["香水","キャンドル","音楽","夜景","映画","ワインレッドの小物",
              "星のモチーフ","シルバーアクセ","日記","照明","ルームライト",
              "写真","詩集","イヤホン","サテン素材","月のモチーフ",
              "アロマオイル","ハンドミラー","黒い服","リップ","ブレスレット",
              "指輪","小さな花","コロン","夜の散歩","プレイリスト",
              "インセンス","シネマチケット","シルバーリング","ストール","ネイル",
              "ムードのある喫茶店","スカーフ","ライト","ミスト","ピアス",
              "夜の空","星空アプリ","メタリック小物","月明かり","余韻を残すもの"],
    }

    lucky_number = {
        "A": [1,2,3,5,6,8,11,15,18,22,24,26,29,33,36,39,41,44,48,52,55,57,60,62,66,69,72,74,77,81,84,86,88,91,93,96,99,101,108,111],
        "B": [4,7,9,10,12,14,16,19,21,23,27,30,32,35,37,40,43,45,49,50,53,56,58,61,64,67,70,73,75,79,82,85,87,90,94,97,100,105,109,113],
        "C": [13,17,20,25,28,31,34,38,42,46,47,51,54,59,63,65,68,71,76,78,80,83,89,92,95,98,102,103,104,106,107,110,112,114,115,116,117,118,119,120],
        "D": [6,9,12,18,24,27,30,36,39,42,48,51,57,60,66,69,72,75,81,84,87,90,93,96,99,101,108,111,113,117,121,123,126,128,131,133,135,138,141,144],
    }

    return {
        "day_theme": day_theme,
        "recommended_move": recommended_move,
        "caution_short": caution_short,
        "love_fortune": love_fortune,
        "work_fortune": work_fortune,
        "money_fortune": money_fortune,
        "crush_advice": crush_advice,
        "luck_tip": luck_tip,
        "lucky_color": lucky_color,
        "lucky_item": lucky_item,
        "lucky_number": lucky_number,
    }


def _validate_bank(bank: Dict[str, Any]) -> None:
    required_top = [
        "day_theme", "recommended_move", "caution_short",
        "love_fortune", "work_fortune", "money_fortune", "crush_advice",
        "luck_tip", "lucky_color", "lucky_item", "lucky_number",
    ]
    _require_keys(bank, required_top, "bank")

    # main keys
    for k in ["day_theme", "recommended_move", "caution_short", "love_fortune", "work_fortune", "money_fortune", "crush_advice", "luck_tip"]:
        _require_keys(bank[k], MAIN_IDS, f"bank.{k}")
        for mid in MAIN_IDS:
            if not _dedupe_keep_order(bank[k][mid]):
                raise ValueError(f"bank.{k}.{mid} is empty")

    # sub keys
    for k in ["lucky_color", "lucky_item", "lucky_number"]:
        _require_keys(bank[k], SUB_PATTERNS, f"bank.{k}")
        for p in SUB_PATTERNS:
            if not _dedupe_keep_order(bank[k][p]):
                raise ValueError(f"bank.{k}.{p} is empty")


@dataclass(frozen=True)
class BuildConfig:
    out: Path
    target_date: Date
    seed: int
    n_slots: int = 40
    version: int = 4


def build_data(cfg: BuildConfig) -> Dict[str, Any]:
    rng = Random(cfg.seed)
    bank = make_bank()
    _validate_bank(bank)

    by_main: Dict[str, Any] = {}
    for mid in MAIN_IDS:
        # 40枠はアプリ側の都合に合わせて維持
        # 短文は「可能な限りユニーク → 足りない分だけ重複」
        by_main[mid] = {
            "day_theme": _pick_n_cycle_mostly_unique(rng, bank["day_theme"][mid], cfg.n_slots),
            "recommended_move": _pick_n_cycle_mostly_unique(rng, bank["recommended_move"][mid], cfg.n_slots),
            # 互換キー（アプリ側で参照されてるなら維持）
            "recommended_action": _pick_n_cycle_mostly_unique(rng, bank["recommended_move"][mid], cfg.n_slots),
            "caution": _pick_n_cycle_mostly_unique(rng, bank["caution_short"][mid], cfg.n_slots),

            # 長文は十分量があるのでユニーク抽選を基本（足りない場合のみ循環）
            "love_fortune": _pick_n_unique_if_possible(rng, bank["love_fortune"][mid], cfg.n_slots),
            "work_fortune": _pick_n_unique_if_possible(rng, bank["work_fortune"][mid], cfg.n_slots),
            "money_fortune": _pick_n_unique_if_possible(rng, bank["money_fortune"][mid], cfg.n_slots),
            "crush_advice": _pick_n_unique_if_possible(rng, bank["crush_advice"][mid], cfg.n_slots),

            "luck_tip": _pick_n_cycle_mostly_unique(rng, bank["luck_tip"][mid], cfg.n_slots),
        }

    by_sub_pattern: Dict[str, Any] = {}
    for p in SUB_PATTERNS:
        by_sub_pattern[p] = {
            "lucky_color": _pick_n_unique_if_possible(rng, bank["lucky_color"][p], cfg.n_slots),
            "lucky_item": _pick_n_unique_if_possible(rng, bank["lucky_item"][p], cfg.n_slots),
            # lucky_number は数値だけどユニーク維持
            "lucky_number": rng.sample(_dedupe_keep_order(bank["lucky_number"][p]), cfg.n_slots),
        }

    return {
        "meta": {
            "version": cfg.version,
            "generated_at": Date.today().isoformat(),
            "target_date": cfg.target_date.isoformat(),
            "seed": cfg.seed,
            "note": "dense readable fortune. long text is sampled uniquely when possible; short fields are filled mostly-unique then cycled if needed.",
        },
        "by_main": by_main,
        "by_sub_pattern": by_sub_pattern,
    }


def parse_args() -> argparse.Namespace:
    p = argparse.ArgumentParser(description="Generate fortune_daily.json for the app.")
    p.add_argument("--out", type=str, default=str(DEFAULT_OUT), help="output json path")
    p.add_argument("--date", type=str, default="", help="target date (YYYY-MM-DD). default: today")
    p.add_argument("--seed", type=int, default=-1, help="override seed (int). default: derived from target date")
    p.add_argument("--slots", type=int, default=40, help="number of slots per category (default 40)")
    return p.parse_args()


def main() -> None:
    args = parse_args()
    out = Path(args.out)

    if args.date:
        y, m, d = [int(x) for x in args.date.split("-")]
        target = Date(y, m, d)
    else:
        target = Date.today()

    seed = args.seed if args.seed >= 0 else _seed_from_date(target)

    cfg = BuildConfig(
        out=out,
        target_date=target,
        seed=seed,
        n_slots=int(args.slots),
    )

    data = build_data(cfg)

    cfg.out.parent.mkdir(parents=True, exist_ok=True)
    cfg.out.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")
    print(f"✅ wrote: {cfg.out} (version={cfg.version}, target_date={cfg.target_date}, seed={cfg.seed})")


if __name__ == "__main__":
    main()
